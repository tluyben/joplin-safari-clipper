{"version":3,"sources":["bridge.js","led_red.png","led_green.png","led_orange.png","randomClipperPort.js","App.js","index.js"],"names":["randomClipperPort","require","msleep","ms","Promise","resolve","setTimeout","bridge_","this","nounce_","Date","now","token_","browser","browserSupportsPromises","store","convertCommandToContent","command","title","body_html","html","base_url","source_url","url","parent_id","tags","image_sizes","anchor_names","source_command","convert_to","stylesheets","console","info","browser_","dispatch_","dispatch","store_","browserSupportsPromises_","clipperServerPort_","clipperServerPortStatus_","browser_notify","a","warning","warn","type","text","name","content","state","getState","selectedFolderId","sendContentToJoplin","value","runtime","onMessage","addListener","backgroundPage","env_","joplinEnv","env","findClipperServerPort","restoreState","restoredState","checkAuth","folderTree","folders","items","page","clipperApiExec","order_by","order_dir","result","resultTags","hasMore","has_more","concat","id","storageGet","existingToken","token","valid","storageSet","existingAuthInfo","authToken","authTokenTimestamp","response","auth_token","status","Error","bgp","extension","getBackgroundPage","action","scheduleStateSaveIID","clearTimeout","toSave","s","foundState","i","port","fetch","trim","reject","checkStatus","operation","searchingClipperServer","waitIID","setInterval","clearInterval","clipperServerPort","options","tabs","executeScript","e","lastError","msg","JSON","stringify","message","push","join","query","tabId","sendMessage","create","as_tree","keys","storage","local","set","defaultValue","get","r","tabsQuery","active","currentWindow","length","tabsSendMessage","method","path","body","clipperServerBaseUrl","baseUrl","fetchOptions","headers","Object","assign","queryString","k","hasOwnProperty","encodeURIComponent","ok","json","uploading","nounce","success","errorMessage","bridge","module","exports","startPort","offset","connect","PreviewComponent","bodyRef","React","createRef","current","imgs","getElementsByTagName","img","width","height","className","props","onChange","onTitleChange","p","preProcessFor","commandUserString","href","onClick","onConfirmClick","PureComponent","AppComponent","contentScriptLoaded","selectedTags","contentScriptError","newNoteId","confirm_click","clippedContent","setState","contentTitle_change","event","currentTarget","clipSimplified_click","sendCommandToActiveTab","clipComplete_click","clipCompleteHtml_click","clipSelection_click","clipUrl_click","clipScreenshot_click","api_base_url","window","close","clipperServerHelpLink_click","tabsCreate","folderSelect_change","target","tagCompChanged","bind","onAddTagClick","onClearTagButtonClick","newTags","slice","focusNewTagInput_","index","getAttribute","splice","Number","tabsExecuteScript","file","onReactAppStarts","loadContentScripts","error","foundSelectedFolderId","searchSelectedFolder","folder","children","newFolderId","lastRef","ref","refs","focus","messages","serverFoundState","authState","clipperServer","authStatus","renderStartupScreen","style","padding","fontSize","maxWidth","warningComponent","hasContent","previewComponent","contentUploadOperation","tagDataListOptions","tag","key","simplifiedPageButtonLabel","simplifiedPageButtonTooltip","isProbablyReaderable","optionComps","addOptions","depth","repeat","replace","foldersComp","comps","data-index","list","onInput","tagsComp","led","helpLink","led_green","charAt","toUpperCase","led_orange","led_red","alt","src","clipperStatusComp","Component","App","Provider","createStore","applyMiddleware","defaultState","reduxMiddleware","next","newState","indexOf","scheduleStateSave","reducer","newContent","init","chrome","ReactDOM","render","document","getElementById","main","catch"],"mappings":"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","file":"static/js/main.chunk.js","sourcesContent":["const { randomClipperPort } = require('./randomClipperPort');\n\nfunction msleep(ms) {\n\treturn new Promise((resolve) => {\n\t\tsetTimeout(() => {\n\t\t\tresolve();\n\t\t}, ms);\n\t});\n}\n\nclass Bridge {\n\n\tconstructor() {\n\t\tthis.nounce_ = Date.now();\n\t\tthis.token_ = null;\n\t}\n\n\tasync init(browser, browserSupportsPromises, store) {\n\t\tconsole.info('Popup: Init bridge');\n\n\t\tthis.browser_ = browser;\n\t\tthis.dispatch_ = store.dispatch;\n\t\tthis.store_ = store;\n\t\tthis.browserSupportsPromises_ = browserSupportsPromises;\n\t\tthis.clipperServerPort_ = null;\n\t\tthis.clipperServerPortStatus_ = 'searching';\n\n\t\tfunction convertCommandToContent(command) {\n\t\t\treturn {\n\t\t\t\ttitle: command.title,\n\t\t\t\tbody_html: command.html,\n\t\t\t\tbase_url: command.base_url,\n\t\t\t\tsource_url: command.url,\n\t\t\t\tparent_id: command.parent_id,\n\t\t\t\ttags: command.tags || '',\n\t\t\t\timage_sizes: command.image_sizes || {},\n\t\t\t\tanchor_names: command.anchor_names || [],\n\t\t\t\tsource_command: command.source_command,\n\t\t\t\tconvert_to: command.convert_to,\n\t\t\t\tstylesheets: command.stylesheets,\n\t\t\t};\n\t\t}\n\n\t\tthis.browser_notify = async (command) => {\n\t\t\tconsole.info('Popup: Got command:', command);\n\n\t\t\tif (command.warning) {\n\t\t\t\tconsole.warn(`Popup: Got warning: ${command.warning}`);\n\t\t\t\tthis.dispatch({ type: 'WARNING_SET', text: command.warning });\n\t\t\t} else {\n\t\t\t\tthis.dispatch({ type: 'WARNING_SET', text: '' });\n\t\t\t}\n\n\t\t\tif (command.name === 'clippedContent') {\n\t\t\t\tconst content = convertCommandToContent(command);\n\t\t\t\tthis.dispatch({ type: 'CLIPPED_CONTENT_SET', content: content });\n\t\t\t}\n\n\t\t\tif (command.name === 'sendContentToJoplin') {\n\t\t\t\tconst content = convertCommandToContent(command);\n\t\t\t\tthis.dispatch({ type: 'CLIPPED_CONTENT_SET', content: content });\n\n\t\t\t\tconst state = this.store_.getState();\n\t\t\t\tcontent.parent_id = state.selectedFolderId;\n\t\t\t\tif (content.parent_id) {\n\t\t\t\t\tthis.sendContentToJoplin(content);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (command.name === 'isProbablyReaderable') {\n\t\t\t\tthis.dispatch({ type: 'IS_PROBABLY_READERABLE', value: command.value });\n\t\t\t}\n\t\t};\n\t\tthis.browser_.runtime.onMessage.addListener(this.browser_notify);\n\t\tconst backgroundPage = await this.backgroundPage(this.browser_);\n\n\t\t// Not sure why the getBackgroundPage() sometimes returns null, so\n\t\t// in that case default to \"prod\" environment, which means the live\n\t\t// extension won't be affected by this bug.\n\t\tthis.env_ = backgroundPage ? backgroundPage.joplinEnv() : 'prod';\n\n\t\tconsole.info('Popup: Env:', this.env());\n\n\t\tthis.dispatch({\n\t\t\ttype: 'ENV_SET',\n\t\t\tenv: this.env(),\n\t\t});\n\t}\n\n\ttoken() {\n\t\treturn this.token_;\n\t}\n\n\tasync onReactAppStarts() {\n\t\tawait this.findClipperServerPort();\n\n\t\tif (this.clipperServerPortStatus_ !== 'found') {\n\t\t\tconsole.info('Skipping initialisation because server port was not found');\n\t\t\treturn;\n\t\t}\n\n\t\tconst restoredState = await this.restoreState();\n\n\t\tawait this.checkAuth();\n\t\tif (!this.token_) return; // Didn't get a token\n\n\t\tconst folders = await this.folderTree();\n\t\tthis.dispatch({ type: 'FOLDERS_SET', folders: folders.items ? folders.items : folders });\n\n\t\tlet tags = [];\n\t\tfor (let page = 1; page < 10000; page++) {\n\t\t\tconst result = await this.clipperApiExec('GET', 'tags', { page: page, order_by: 'title', order_dir: 'ASC' });\n\t\t\tconst resultTags = result.items ? result.items : result;\n\t\t\tconst hasMore = ('has_more' in result) && result.has_more;\n\t\t\ttags = tags.concat(resultTags);\n\t\t\tif (!hasMore) break;\n\t\t}\n\n\t\tthis.dispatch({ type: 'TAGS_SET', tags: tags });\n\t\tif (restoredState.selectedFolderId) this.dispatch({ type: 'SELECTED_FOLDER_SET', id: restoredState.selectedFolderId });\n\t}\n\n\tasync checkAuth() {\n\t\tthis.dispatch({ type: 'AUTH_STATE_SET', value: 'starting' });\n\n\t\tconst existingToken = await this.storageGet(['token']);\n\t\tthis.token_ = existingToken.token;\n\n\t\tconst authCheckResponse = await this.clipperApiExec('GET', 'auth/check', { token: this.token_ });\n\n\t\tif (authCheckResponse.valid) {\n\t\t\tconsole.info('checkAuth: we already have a valid token - exiting');\n\t\t\tthis.dispatch({ type: 'AUTH_STATE_SET', value: 'accepted' });\n\t\t\treturn;\n\t\t}\n\n\t\tthis.token_ = null;\n\t\tawait this.storageSet({ token: this.token_ });\n\n\t\tthis.dispatch({ type: 'AUTH_STATE_SET', value: 'waiting' });\n\n\t\t// Note that Firefox and Chrome works differently for this:\n\t\t//\n\t\t// - In Chrome, the popup stays open, even when the user leaves the\n\t\t//   browser to grant permission in the application.\n\t\t//\n\t\t// - In Firefox, as soon as the browser loses focus, the popup closes.\n\t\t//\n\t\t//   It means we can't rely on local state to get this working - instead\n\t\t//   we request the auth token, and cache it to local storage (along\n\t\t//   with a timestamp). Then next time the user opens the popup (after\n\t\t//   it was automatically closed by Firefox), that cached auth token is\n\t\t//   re-used and the auth process continues.\n\t\t//\n\t\t// https://github.com/laurent22/joplin/issues/5125#issuecomment-869547421\n\n\t\tconst existingAuthInfo = await this.storageGet(['authToken', 'authTokenTimestamp']);\n\n\t\tlet authToken = null;\n\t\tif (existingAuthInfo.authToken && Date.now() - existingAuthInfo.authTokenTimestamp < 5 * 60 * 1000) {\n\t\t\tconsole.info('checkAuth: we already have an auth token - reusing it');\n\t\t\tauthToken = existingAuthInfo.authToken;\n\t\t} else {\n\t\t\tconsole.info('checkAuth: we do not have an auth token - requesting it...');\n\t\t\tconst response = await this.clipperApiExec('POST', 'auth');\n\t\t\tauthToken = response.auth_token;\n\n\t\t\tawait this.storageSet({ authToken: authToken, authTokenTimestamp: Date.now() });\n\t\t}\n\n\t\tconsole.info('checkAuth: we do not have a token - requesting one using auth_token: ', authToken);\n\n\t\ttry {\n\t\t\twhile (true) {\n\t\t\t\tconst response = await this.clipperApiExec('GET', 'auth/check', { auth_token: authToken });\n\n\t\t\t\tif (response.status === 'rejected') {\n\t\t\t\t\tconsole.info('checkAuth: Auth request was not accepted', response);\n\t\t\t\t\tthis.dispatch({ type: 'AUTH_STATE_SET', value: 'rejected' });\n\t\t\t\t\tbreak;\n\t\t\t\t} else if (response.status === 'accepted') {\n\t\t\t\t\tconsole.info('checkAuth: Auth request was accepted', response);\n\t\t\t\t\tthis.dispatch({ type: 'AUTH_STATE_SET', value: 'accepted' });\n\t\t\t\t\tthis.token_ = response.token;\n\t\t\t\t\tawait this.storageSet({ token: this.token_ });\n\t\t\t\t\tbreak;\n\t\t\t\t} else if (response.status === 'waiting') {\n\t\t\t\t\tawait msleep(1000);\n\t\t\t\t} else {\n\t\t\t\t\tthrow new Error(`Unknown auth/check status: ${response.status}`);\n\t\t\t\t}\n\t\t\t}\n\t\t} finally {\n\t\t\tawait this.storageSet({ authToken: '', authTokenTimestamp: 0 });\n\t\t}\n\t}\n\n\tasync backgroundPage(browser) {\n\t\tconst bgp = browser.extension.getBackgroundPage();\n\t\tif (bgp) return bgp;\n\n\t\treturn new Promise((resolve) => {\n\t\t\tbrowser.runtime.getBackgroundPage((bgp) => {\n\t\t\t\tresolve(bgp);\n\t\t\t});\n\t\t});\n\t}\n\n\tenv() {\n\t\treturn this.env_;\n\t}\n\n\tbrowser() {\n\t\treturn this.browser_;\n\t}\n\n\tdispatch(action) {\n\t\treturn this.dispatch_(action);\n\t}\n\n\tscheduleStateSave(state) {\n\t\tif (this.scheduleStateSaveIID) {\n\t\t\tclearTimeout(this.scheduleStateSaveIID);\n\t\t\tthis.scheduleStateSaveIID = null;\n\t\t}\n\n\t\tthis.scheduleStateSaveIID = setTimeout(() => {\n\t\t\tthis.scheduleStateSaveIID = null;\n\n\t\t\tconst toSave = {\n\t\t\t\tselectedFolderId: state.selectedFolderId,\n\t\t\t};\n\n\t\t\tconsole.info('Popup: Saving state', toSave);\n\n\t\t\tthis.storageSet(toSave);\n\t\t}, 100);\n\t}\n\n\tasync restoreState() {\n\t\tconst s = await this.storageGet(null);\n\t\tconsole.info('Popup: Restoring saved state:', s);\n\t\treturn s;\n\t}\n\n\tasync findClipperServerPort() {\n\t\tthis.dispatch({ type: 'CLIPPER_SERVER_SET', foundState: 'searching' });\n\n\t\tlet state = null;\n\t\tfor (let i = 0; i < 10; i++) {\n\t\t\tstate = randomClipperPort(state, this.env());\n\n\t\t\ttry {\n\t\t\t\tconsole.info(`findClipperServerPort: Trying ${state.port}`);\n\t\t\t\tconst response = await fetch(`http://127.0.0.1:${state.port}/ping`);\n\t\t\t\tconst text = await response.text();\n\t\t\t\tconsole.info(`findClipperServerPort: Got response: ${text}`);\n\t\t\t\tif (text.trim() === 'JoplinClipperServer') {\n\t\t\t\t\tthis.clipperServerPortStatus_ = 'found';\n\t\t\t\t\tthis.clipperServerPort_ = state.port;\n\t\t\t\t\tthis.dispatch({ type: 'CLIPPER_SERVER_SET', foundState: 'found', port: state.port });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\t// continue\n\t\t\t}\n\t\t}\n\n\t\tthis.clipperServerPortStatus_ = 'not_found';\n\n\t\tthis.dispatch({ type: 'CLIPPER_SERVER_SET', foundState: 'not_found' });\n\n\t\treturn null;\n\t}\n\n\tasync clipperServerPort() {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst checkStatus = () => {\n\t\t\t\tif (this.clipperServerPortStatus_ === 'not_found') {\n\t\t\t\t\treject(new Error('Could not find clipper service. Please make sure that Joplin is running and that the clipper server is enabled.'));\n\t\t\t\t\treturn true;\n\t\t\t\t} else if (this.clipperServerPortStatus_ === 'found') {\n\t\t\t\t\tresolve(this.clipperServerPort_);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\t};\n\n\t\t\tif (checkStatus()) return;\n\n\t\t\tthis.dispatch({ type: 'CONTENT_UPLOAD', operation: { searchingClipperServer: true } });\n\n\t\t\tconst waitIID = setInterval(() => {\n\t\t\t\tif (!checkStatus()) return;\n\t\t\t\tthis.dispatch({ type: 'CONTENT_UPLOAD', operation: null });\n\t\t\t\tclearInterval(waitIID);\n\t\t\t}, 1000);\n\t\t});\n\t}\n\n\tasync clipperServerBaseUrl() {\n\t\tconst port = await this.clipperServerPort();\n\t\treturn `http://127.0.0.1:${port}`;\n\t}\n\n\tasync tabsExecuteScript(options) {\n\t\tif (this.browserSupportsPromises_) return this.browser().tabs.executeScript(options);\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.browser().tabs.executeScript(options, () => {\n\t\t\t\tconst e = this.browser().runtime.lastError;\n\t\t\t\tif (e) {\n\t\t\t\t\tconst msg = [`tabsExecuteScript: Cannot load ${JSON.stringify(options)}`];\n\t\t\t\t\tif (e.message) msg.push(e.message);\n\t\t\t\t\treject(new Error(msg.join(': ')));\n\t\t\t\t}\n\t\t\t\tresolve();\n\t\t\t});\n\t\t});\n\t}\n\n\tasync tabsQuery(options) {\n\t\tif (this.browserSupportsPromises_) return this.browser().tabs.query(options);\n\n\t\treturn new Promise((resolve) => {\n\t\t\tthis.browser().tabs.query(options, (tabs) => {\n\t\t\t\tresolve(tabs);\n\t\t\t});\n\t\t});\n\t}\n\n\tasync tabsSendMessage(tabId, command) {\n\t\tif (this.browserSupportsPromises_) return this.browser().tabs.sendMessage(tabId, command);\n\n\t\treturn new Promise((resolve) => {\n\t\t\tthis.browser().tabs.sendMessage(tabId, command, (result) => {\n\t\t\t\tresolve(result);\n\t\t\t});\n\t\t});\n\t}\n\n\tasync tabsCreate(options) {\n\t\tif (this.browserSupportsPromises_) return this.browser().tabs.create(options);\n\n\t\treturn new Promise((resolve) => {\n\t\t\tthis.browser().tabs.create(options, () => {\n\t\t\t\tresolve();\n\t\t\t});\n\t\t});\n\t}\n\n\tasync folderTree() {\n\t\treturn this.clipperApiExec('GET', 'folders', { as_tree: 1 });\n\t}\n\n\tasync storageSet(keys) {\n\t\tif (this.browserSupportsPromises_) return this.browser().storage.local.set(keys);\n\n\t\treturn new Promise((resolve) => {\n\t\t\tthis.browser().storage.local.set(keys, () => {\n\t\t\t\tresolve();\n\t\t\t});\n\t\t});\n\t}\n\n\tasync storageGet(keys, defaultValue = null) {\n\t\tif (this.browserSupportsPromises_) {\n\t\t\ttry {\n\t\t\t\tconst r = await this.browser().storage.local.get(keys);\n\t\t\t\treturn r;\n\t\t\t} catch (error) {\n\t\t\t\treturn defaultValue;\n\t\t\t}\n\t\t} else {\n\t\t\treturn new Promise((resolve) => {\n\t\t\t\tthis.browser().storage.local.get(keys, (result) => {\n\t\t\t\t\tresolve(result);\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t}\n\n\tasync sendCommandToActiveTab(command) {\n\t\tconst tabs = await this.tabsQuery({ active: true, currentWindow: true });\n\t\tif (!tabs.length) {\n\t\t\tconsole.warn('No valid tab');\n\t\t\treturn;\n\t\t}\n\n\t\tthis.dispatch({ type: 'CONTENT_UPLOAD', operation: null });\n\n\t\tconsole.info('Sending message ', command);\n\n\t\tawait this.tabsSendMessage(tabs[0].id, command);\n\t}\n\n\tasync clipperApiExec(method, path, query, body) {\n\t\tconsole.info(`Popup: ${method} ${path}`);\n\n\t\tconst baseUrl = await this.clipperServerBaseUrl();\n\n\t\tconst fetchOptions = {\n\t\t\tmethod: method,\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t},\n\t\t};\n\n\t\tif (body) fetchOptions.body = typeof body === 'string' ? body : JSON.stringify(body);\n\n\t\tquery = Object.assign(query || {}, { token: this.token_ });\n\n\t\tlet queryString = '';\n\t\tif (query) {\n\t\t\tconst s = [];\n\t\t\tfor (const k in query) {\n\t\t\t\tif (!query.hasOwnProperty(k)) continue;\n\t\t\t\ts.push(`${encodeURIComponent(k)}=${encodeURIComponent(query[k])}`);\n\t\t\t}\n\t\t\tqueryString = s.join('&');\n\t\t\tif (queryString) queryString = `?${queryString}`;\n\t\t}\n\n\t\tconst response = await fetch(`${baseUrl}/${path}${queryString}`, fetchOptions);\n\t\tif (!response.ok) {\n\t\t\tconst msg = await response.text();\n\t\t\tthrow new Error(msg);\n\t\t}\n\n\t\tconst json = await response.json();\n\t\treturn json;\n\t}\n\n\tasync sendContentToJoplin(content) {\n\t\tconsole.info('Popup: Sending to Joplin...');\n\n\t\ttry {\n\t\t\tthis.dispatch({ type: 'CONTENT_UPLOAD', operation: { uploading: true } });\n\n\t\t\tif (!content) throw new Error('Cannot send empty content');\n\n\t\t\t// There is a bug in Chrome that somehow makes the app send the same request twice, which\n\t\t\t// results in Joplin having the same note twice. There's a 2-3 sec delay between\n\t\t\t// each request. The bug only happens the first time the extension popup is open and the\n\t\t\t// Complete button is clicked.\n\t\t\t//\n\t\t\t// It's beyond my understanding how it's happening. I don't know how this sendContentToJoplin function\n\t\t\t// can be called twice. But even if it is, logically, it's impossible that this\n\t\t\t// call below would be done with twice the same nounce. Even if the function sendContentToJoplin\n\t\t\t// is called twice in parallel, the increment is atomic and should result in two nounces\n\t\t\t// being generated. But it's not. Somehow the function below is called twice with the exact same nounce.\n\t\t\t//\n\t\t\t// It's also not something internal to Chrome that repeat the request since the error is caught\n\t\t\t// so it really seems like a double function call.\n\t\t\t//\n\t\t\t// So this is why below, when we get the duplicate nounce error, we just ignore it so as not to display\n\t\t\t// a useless error message. The whole nounce feature is not for security (it's not to prevent replay\n\t\t\t// attacks), but simply to detect these double-requests and ignore them on Joplin side.\n\t\t\t//\n\t\t\t// This nounce feature is optional, it's only active when the nounce query parameter is provided\n\t\t\t// so it shouldn't affect any other call.\n\t\t\t//\n\t\t\t// This is the perfect Heisenbug - it happens always when opening the popup the first time EXCEPT\n\t\t\t// when the debugger is open. Then everything is working fine and the bug NEVER EVER happens,\n\t\t\t// so it's impossible to understand what's going on.\n\t\t\tconst response = await this.clipperApiExec('POST', 'notes', { nounce: this.nounce_++ }, content);\n\n\t\t\tthis.dispatch({ type: 'CONTENT_UPLOAD', operation: { uploading: false, success: true } });\n\n\t\t\treturn response;\n\t\t} catch (error) {\n\t\t\tif (error.message === '{\"error\":\"Duplicate Nounce\"}') {\n\t\t\t\tthis.dispatch({ type: 'CONTENT_UPLOAD', operation: { uploading: false, success: true } });\n\t\t\t} else {\n\t\t\t\tthis.dispatch({ type: 'CONTENT_UPLOAD', operation: { uploading: false, success: false, errorMessage: error.message } });\n\t\t\t}\n\t\t}\n\t}\n}\n\nconst bridge_ = new Bridge();\n\nconst bridge = function() {\n\treturn bridge_;\n};\n\n// eslint-disable-next-line import/prefer-default-export\nexport { bridge };\n","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQlJREFUeNpiXOjAwMD3kcFcSMeyls/Jz/w/ExPjwyNbTz88d6iF5R/DUYYFNgzm16ri3v579fo/DPx79+7/6fq0j5N0GWxZJP6w1mv+EhRieP+CgeHXVwYGBkYGxu+fGUz+CPI9/8vaxCLHpWDGcPMmA8Oe7QwMikoMYPDwPgPD1UsMioIK+iwcfCKMDLo6DAxszAwMH95CFLAC2braDIxXPjEyPf32+iyDsgoDg6gEAwMnHwSLiDMwqKgz3Pv77jLT/ed3G89cP/qJgYWHgYFblIGBB4hZeBnO3zr+5eGTmw3MQRIMj288unTk5Yt7cn9+fRd8/fT2jxMHV5y4dGJzBvPf//sBAgwATg5okojpGQ0AAAAASUVORK5CYII=\"","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQlJREFUeNpi5FzIwCDKx2BuImRZa8vnZ874n4lx18Otp488PNTCwsJwlIFnAYN5xbW4t1/+vfoPA1//vftffTrto+gkBlsWMQnWemNNQaG3DC8ZvgEhIxB+ZfzMYGoiyLf5OWsTs1uV8kQR0X9cPxn+Mvxg+M7wjuEZwwOG0wyPGU4w/Pn9j59FlEOEUYRBh+EfAzPDZ4a3DBDAzCDKoM3Ay/iJkenu09dnRRlUGAQZJBh4GfjAWIBBnEGSQZ3hxr13l5l/Or6/x/FbMMRUyoCdHyjJxcAN1M/EsOH8ni/bLu/NYJRezMDw8Q2DjbWiWb2jspUxIyMjw6G7Jy4cfnC8iZWF4QBAgAEAwzdc4OHO/RAAAAAASUVORK5CYII=\"","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQVJREFUeNo0js1KAlEAhb87XsG0BkYHciEy/UBFQYuioaAnCHqEli16h7KGnqAnKFoFbaNtRGIwRVEgjKA2C5k0NNTMCPI2JB04cBYfh0+cOKD3sZOZ1V19dtNWQhN+8cL1S9eHEvIc72EXz7eag3ZD/WfQayn3bLt9tMO6TMtobk4aSb7r0PkEJRA/XZYThh7Eoo7Mjlgr1D0oXUJqkr+8VyF4YsKwFmUsbgqyCxCNwFdzCMhwZ+YRvY7Qat23e8xpSKQhog8bHw/fZqj0W89a9bV8cOflO6hR0FIhYIYeYzxUCh9+4O1LIVT+xj3dqDW83JS1thQqUvZvH1/8giMVV78CDAB2jGGahqf6iwAAAABJRU5ErkJggg==\"","function randomClipperPort(state, env) {\n\tif (!state) {\n\t\tstate = { offset: 0 };\n\t} else {\n\t\tstate.offset++;\n\t}\n\n\tstate.port = startPort(env) + state.offset;\n\n\treturn state;\n}\n\nfunction startPort(env) {\n\tconst startPorts = {\n\t\tprod: 41184,\n\t\tdev: 27583,\n\t};\n\n\treturn env === 'prod' ? startPorts.prod : startPorts.dev;\n}\n\nmodule.exports = { randomClipperPort, startPort };\n","import React, { Component } from 'react';\nimport './App.css';\nimport led_red from './led_red.png';\nimport led_green from './led_green.png';\nimport led_orange from './led_orange.png';\n\nconst { connect } = require('react-redux');\nconst { bridge } = require('./bridge');\n\nfunction commandUserString(command) {\n\tconst s = [];\n\n\tif (command.name === 'simplifiedPageHtml') s.push('Simplified page');\n\tif (command.name === 'completePageHtml') s.push('Complete page');\n\tif (command.name === 'selectedHtml') s.push('Selection');\n\tif (command.name === 'pageUrl') s.push('URL only');\n\n\tconst p = command.preProcessFor ? command.preProcessFor : 'markdown';\n\ts.push(`(${p})`);\n\n\treturn s.join(' ');\n}\n\nclass PreviewComponent extends React.PureComponent {\n\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.bodyRef = React.createRef();\n\t}\n\n\tcomponentDidMount() {\n\t\tif (!this.bodyRef.current) return;\n\n\t\t// Because the text size is made twice smaller with CSS, we need\n\t\t// to also reduce the size of the images\n\t\tconst imgs = this.bodyRef.current.getElementsByTagName('img');\n\t\tfor (const img of imgs) {\n\t\t\timg.width /= 2;\n\t\t\timg.height /= 2;\n\t\t}\n\t}\n\n\trender() {\n\t\treturn (\n\t\t\t<div className=\"Preview\">\n\t\t\t\t<h2>Title:</h2>\n\t\t\t\t<input className={'Title'} value={this.props.title} onChange={this.props.onTitleChange}/>\n\t\t\t\t<p><span>Type:</span> {commandUserString(this.props.command)}</p>\n\t\t\t\t<a className={'Confirm Button'} href=\"#\" onClick={this.props.onConfirmClick}>Confirm</a>\n\t\t\t</div>\n\t\t);\n\t}\n\n}\n\nclass AppComponent extends Component {\n\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.state = ({\n\t\t\tcontentScriptLoaded: false,\n\t\t\tselectedTags: [],\n\t\t\tcontentScriptError: '',\n\t\t\tnewNoteId: null,\n\t\t});\n\n\t\tthis.confirm_click = async () => {\n\t\t\tconst content = Object.assign({}, this.props.clippedContent);\n\t\t\tcontent.tags = this.state.selectedTags.join(',');\n\t\t\tcontent.parent_id = this.props.selectedFolderId;\n\t\t\tconst response = await bridge().sendContentToJoplin(content);\n\t\t\tthis.setState({ newNoteId: response.id });\n\t\t};\n\n\t\tthis.contentTitle_change = (event) => {\n\t\t\tthis.props.dispatch({\n\t\t\t\ttype: 'CLIPPED_CONTENT_TITLE_SET',\n\t\t\t\ttext: event.currentTarget.value,\n\t\t\t});\n\t\t};\n\n\t\tthis.clipSimplified_click = () => {\n\t\t\tbridge().sendCommandToActiveTab({\n\t\t\t\tname: 'simplifiedPageHtml',\n\t\t\t});\n\t\t};\n\n\t\tthis.clipComplete_click = () => {\n\t\t\tbridge().sendCommandToActiveTab({\n\t\t\t\tname: 'completePageHtml',\n\t\t\t\tpreProcessFor: 'markdown',\n\t\t\t});\n\t\t};\n\n\t\tthis.clipCompleteHtml_click = () => {\n\t\t\tbridge().sendCommandToActiveTab({\n\t\t\t\tname: 'completePageHtml',\n\t\t\t\tpreProcessFor: 'html',\n\t\t\t});\n\t\t};\n\n\t\tthis.clipSelection_click = () => {\n\t\t\tbridge().sendCommandToActiveTab({\n\t\t\t\tname: 'selectedHtml',\n\t\t\t});\n\t\t};\n\n\t\tthis.clipUrl_click = () => {\n\t\t\tbridge().sendCommandToActiveTab({\n\t\t\t\tname: 'pageUrl',\n\t\t\t});\n\t\t};\n\n\t\tthis.clipScreenshot_click = async () => {\n\t\t\ttry {\n\t\t\t\tconst baseUrl = await bridge().clipperServerBaseUrl();\n\n\t\t\t\tawait bridge().sendCommandToActiveTab({\n\t\t\t\t\tname: 'screenshot',\n\t\t\t\t\tapi_base_url: baseUrl,\n\t\t\t\t\tparent_id: this.props.selectedFolderId,\n\t\t\t\t\ttags: this.state.selectedTags.join(','),\n\t\t\t\t\ttoken: bridge().token(),\n\t\t\t\t});\n\n\t\t\t\twindow.close();\n\t\t\t} catch (error) {\n\t\t\t\tthis.props.dispatch({ type: 'CONTENT_UPLOAD', operation: { uploading: false, success: false, errorMessage: error.message } });\n\t\t\t}\n\t\t};\n\n\t\tthis.clipperServerHelpLink_click = () => {\n\t\t\tbridge().tabsCreate({ url: 'https://joplinapp.org/clipper/' });\n\t\t};\n\n\t\tthis.folderSelect_change = (event) => {\n\t\t\tthis.props.dispatch({\n\t\t\t\ttype: 'SELECTED_FOLDER_SET',\n\t\t\t\tid: event.target.value,\n\t\t\t});\n\t\t};\n\n\t\tthis.tagCompChanged = this.tagCompChanged.bind(this);\n\t\tthis.onAddTagClick = this.onAddTagClick.bind(this);\n\t\tthis.onClearTagButtonClick = this.onClearTagButtonClick.bind(this);\n\t}\n\n\tonAddTagClick() {\n\t\tconst newTags = this.state.selectedTags.slice();\n\t\tnewTags.push('');\n\t\tthis.setState({ selectedTags: newTags });\n\t\tthis.focusNewTagInput_ = true;\n\t}\n\n\tonClearTagButtonClick(event) {\n\t\tconst index = event.target.getAttribute('data-index');\n\t\tconst newTags = this.state.selectedTags.slice();\n\t\tnewTags.splice(index, 1);\n\t\tthis.setState({ selectedTags: newTags });\n\t}\n\n\ttagCompChanged(event) {\n\t\tconst index = Number(event.target.getAttribute('data-index'));\n\t\tconst value = event.target.value;\n\n\t\tif (this.state.selectedTags.length <= index) {\n\t\t\tconst newTags = this.state.selectedTags.slice();\n\t\t\tnewTags.push(value);\n\t\t\tthis.setState({ selectedTags: newTags });\n\t\t} else {\n\t\t\tif (this.state.selectedTags[index] !== value) {\n\t\t\t\tconst newTags = this.state.selectedTags.slice();\n\t\t\t\tnewTags[index] = value;\n\t\t\t\tthis.setState({ selectedTags: newTags });\n\t\t\t}\n\t\t}\n\t}\n\n\tasync loadContentScripts() {\n\t\tawait bridge().tabsExecuteScript({ file: '/content_scripts/JSDOMParser.js' });\n\t\tawait bridge().tabsExecuteScript({ file: '/content_scripts/Readability.js' });\n\t\tawait bridge().tabsExecuteScript({ file: '/content_scripts/Readability-readerable.js' });\n\t\tawait bridge().tabsExecuteScript({ file: '/content_scripts/index.js' });\n\t}\n\n\tasync componentDidMount() {\n\t\tbridge().onReactAppStarts();\n\n\t\ttry {\n\t\t\tawait this.loadContentScripts();\n\t\t} catch (error) {\n\t\t\tconsole.error('Could not load content scripts', error);\n\t\t\tthis.setState({ contentScriptError: error.message });\n\t\t\treturn;\n\t\t}\n\n\t\tthis.setState({\n\t\t\tcontentScriptLoaded: true,\n\t\t});\n\n\t\tlet foundSelectedFolderId = false;\n\n\t\tconst searchSelectedFolder = (folders) => {\n\t\t\tfor (let i = 0; i < folders.length; i++) {\n\t\t\t\tconst folder = folders[i];\n\t\t\t\tif (folder.id === this.props.selectedFolderId) foundSelectedFolderId = true;\n\t\t\t\tif (folder.children) searchSelectedFolder(folder.children);\n\t\t\t}\n\t\t};\n\n\t\tsearchSelectedFolder(this.props.folders);\n\n\t\tif (!foundSelectedFolderId) {\n\t\t\tconst newFolderId = this.props.folders.length ? this.props.folders[0].id : null;\n\t\t\tthis.props.dispatch({\n\t\t\t\ttype: 'SELECTED_FOLDER_SET',\n\t\t\t\tid: newFolderId,\n\t\t\t});\n\t\t}\n\n\t\tbridge().sendCommandToActiveTab({ name: 'isProbablyReaderable' });\n\t}\n\n\tcomponentDidUpdate() {\n\t\tif (this.focusNewTagInput_) {\n\t\t\tthis.focusNewTagInput_ = false;\n\t\t\tlet lastRef = null;\n\t\t\tfor (let i = 0; i < 100; i++) {\n\t\t\t\tconst ref = this.refs[`tagSelector${i}`];\n\t\t\t\tif (!ref) break;\n\t\t\t\tlastRef = ref;\n\t\t\t}\n\t\t\tif (lastRef) lastRef.focus();\n\t\t}\n\t}\n\n\trenderStartupScreen() {\n\t\tconst messages = {\n\t\t\tserverFoundState: {\n\t\t\t\t// We need to display the \"Connecting to the Joplin\n\t\t\t\t// application...\" message because if the app doesn't currently\n\t\t\t\t// allow access to the clipper API, the clipper tries several\n\t\t\t\t// ports and it takes time before failing. So if we don't\n\t\t\t\t// display any message, it looks like it's not doing anything\n\t\t\t\t// when clicking on the extension button.\n\t\t\t\t'searching': 'Connecting to the Joplin application...',\n\t\t\t\t'not_found': 'Error: Could not connect to the Joplin application. Please ensure that it is started and that the clipper service is enabled in the configuration.',\n\t\t\t},\n\t\t\tauthState: {\n\t\t\t\t'starting': 'Starting...',\n\t\t\t\t'waiting': 'The Joplin Web Clipper requires your authorisation in order to access your data. To proceed, please open the Joplin desktop application and grant permission. Note: Joplin 2.1+ is needed to use this version of the Web Clipper.',\n\t\t\t\t'rejected': 'Permission to access your data was not granted. To try again please close this popup and open it again.',\n\t\t\t},\n\t\t};\n\n\t\tconst foundState = this.props.clipperServer.foundState;\n\n\t\tlet msg = '';\n\t\tlet title = '';\n\n\t\tif (messages.serverFoundState[foundState]) {\n\t\t\tmsg = messages.serverFoundState[foundState];\n\t\t} else {\n\t\t\tmsg = messages.authState[this.props.authStatus];\n\t\t\ttitle = <h1>{'Permission needed'}</h1>;\n\t\t}\n\n\t\tif (!msg) throw new Error(`Invalidate state: ${foundState} / ${this.props.authStatus}`);\n\n\t\treturn (\n\t\t\t<div className=\"App Startup\">\n\t\t\t\t{title}\n\t\t\t\t{msg}\n\t\t\t</div>\n\t\t);\n\t}\n\n\trender() {\n\t\tif (this.props.authStatus !== 'accepted') {\n\t\t\treturn this.renderStartupScreen();\n\t\t}\n\n\t\tif (!this.state.contentScriptLoaded) {\n\t\t\tlet msg = 'Loading...';\n\t\t\tif (this.state.contentScriptError) msg = `The Joplin extension is not available on this tab due to: ${this.state.contentScriptError}`;\n\t\t\treturn <div style={{ padding: 10, fontSize: 12, maxWidth: 200 }}>{msg}</div>;\n\t\t}\n\n\t\tconst warningComponent = !this.props.warning ? null : <div className=\"Warning\">{ this.props.warning }</div>;\n\n\t\tconst hasContent = !!this.props.clippedContent;\n\t\tconst content = this.props.clippedContent;\n\n\t\tlet previewComponent = null;\n\n\t\tconst operation = this.props.contentUploadOperation;\n\n\t\tif (operation) {\n\t\t\tlet msg = '';\n\n\t\t\tif (operation.searchingClipperServer) {\n\t\t\t\tmsg = 'Searching clipper service... Please make sure that Joplin is running.';\n\t\t\t} else if (operation.uploading) {\n\t\t\t\tmsg = 'Processing note... The note will be available in Joplin as soon as the web page and images have been downloaded and converted. In the meantime you may close this popup.';\n\t\t\t} else if (operation.success) {\n\t\t\t\tmsg = 'Note was successfully created!';\n\t\t\t} else {\n\t\t\t\tmsg = `There was some error creating the note: ${operation.errorMessage}`;\n\t\t\t}\n\n\t\t\tpreviewComponent = (\n\t\t\t\t<div className=\"Preview\">\n\t\t\t\t\t<p className=\"Info\">{ msg }</p>\n\t\t\t\t</div>\n\t\t\t);\n\t\t} else if (hasContent) {\n\t\t\tpreviewComponent = <PreviewComponent\n\t\t\t\tonConfirmClick={this.confirm_click}\n\t\t\t\ttitle={content.title}\n\t\t\t\tbody_html={content.body_html}\n\t\t\t\tonTitleChange={this.contentTitle_change}\n\t\t\t\tcommand={content.source_command}\n\t\t\t/>;\n\t\t}\n\n\t\tconst clipperStatusComp = () => {\n\n\t\t\tconst stateToString = function(state) {\n\t\t\t\tif (state === 'not_found') return 'Not found';\n\t\t\t\treturn state.charAt(0).toUpperCase() + state.slice(1);\n\t\t\t};\n\n\t\t\tlet msg = '';\n\t\t\tlet led = null;\n\t\t\tlet helpLink = null;\n\n\t\t\tconst foundState = this.props.clipperServer.foundState;\n\n\t\t\tif (foundState === 'found') {\n\t\t\t\tmsg = `Ready on port ${this.props.clipperServer.port}`;\n\t\t\t\tled = led_green;\n\t\t\t} else {\n\t\t\t\tmsg = stateToString(foundState);\n\t\t\t\tled = foundState === 'searching' ? led_orange : led_red;\n\t\t\t\tif (foundState === 'not_found') helpLink = <a className=\"Help\" onClick={this.clipperServerHelpLink_click} href=\"help\">[Help]</a>;\n\t\t\t}\n\n\t\t\tmsg = `Service status: ${msg}`;\n\n\t\t\treturn <div className=\"StatusBar\"><img alt={foundState} className=\"Led\" src={led}/><span className=\"ServerStatus\">{ msg }{ helpLink }</span></div>;\n\t\t};\n\n\t\tconst foldersComp = () => {\n\t\t\tconst optionComps = [];\n\n\t\t\tconst nonBreakingSpacify = (s) => {\n\t\t\t\t// https://stackoverflow.com/a/24437562/561309\n\t\t\t\treturn s.replace(/ /g, '\\u00a0');\n\t\t\t};\n\n\t\t\tconst addOptions = (folders, depth) => {\n\t\t\t\tfor (let i = 0; i < folders.length; i++) {\n\t\t\t\t\tconst folder = folders[i];\n\t\t\t\t\toptionComps.push(<option key={folder.id} value={folder.id}>{nonBreakingSpacify('    '.repeat(depth) + folder.title)}</option>);\n\t\t\t\t\tif (folder.children) addOptions(folder.children, depth + 1);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\taddOptions(this.props.folders, 0);\n\n\t\t\treturn (\n\t\t\t\t<div className=\"Folders\">\n\t\t\t\t\t<label>In notebook: </label>\n\t\t\t\t\t<select value={this.props.selectedFolderId || ''} onChange={this.folderSelect_change}>\n\t\t\t\t\t\t{ optionComps }\n\t\t\t\t\t</select>\n\t\t\t\t</div>\n\t\t\t);\n\t\t};\n\n\t\tconst tagsComp = () => {\n\t\t\tconst comps = [];\n\t\t\tfor (let i = 0; i < this.state.selectedTags.length; i++) {\n\t\t\t\tcomps.push(<div key={i}>\n\t\t\t\t\t<input\n\t\t\t\t\t\tref={`tagSelector${i}`}\n\t\t\t\t\t\tdata-index={i}\n\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\tlist=\"tags\"\n\t\t\t\t\t\tvalue={this.state.selectedTags[i]}\n\t\t\t\t\t\tonChange={this.tagCompChanged}\n\t\t\t\t\t\tonInput={this.tagCompChanged}\n\t\t\t\t\t/>\n\t\t\t\t\t<a data-index={i} href=\"#\" className=\"ClearTagButton\" onClick={this.onClearTagButtonClick}>[x]</a>\n\t\t\t\t</div>);\n\t\t\t}\n\t\t\treturn (\n\t\t\t\t<div>\n\t\t\t\t\t{comps}\n\t\t\t\t\t<a className=\"AddTagButton\" href=\"#\" onClick={this.onAddTagClick}>Add tag</a>\n\t\t\t\t</div>\n\t\t\t);\n\t\t};\n\n\t\tconst openNewNoteButton = () => {\n\n\t\t\tif (!this.state.newNoteId) { return null; } else {\n\t\t\t\treturn (\n\t\t\t\t\t// The jopin:// link must be opened in a new tab. When it's opened for the first time, a system dialog will ask for the user's permission.\n\t\t\t\t\t// The system dialog is too big to fit into the popup so the user will not be able to see the dialog buttons and get stuck.\n\t\t\t\t\t<a\n\t\t\t\t\t\tclassName=\"Button\"\n\t\t\t\t\t\thref={`joplin://x-callback-url/openNote?id=${encodeURIComponent(this.state.newNoteId)}`}\n\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\tonClick={() => this.setState({ newNoteId: null })}\n\t\t\t\t\t>\n          Open newly created note\n\t\t\t\t\t</a>\n\t\t\t\t);\n\t\t\t}\n\t\t};\n\n\t\tconst tagDataListOptions = [];\n\t\tfor (let i = 0; i < this.props.tags.length; i++) {\n\t\t\tconst tag = this.props.tags[i];\n\t\t\ttagDataListOptions.push(<option key={tag.id}>{tag.title}</option>);\n\t\t}\n\n\t\tlet simplifiedPageButtonLabel = 'Clip simplified page';\n\t\tlet simplifiedPageButtonTooltip = '';\n\t\tif (!this.props.isProbablyReaderable) {\n\t\t\tsimplifiedPageButtonLabel += ' ⚠️';\n\t\t\tsimplifiedPageButtonTooltip = 'It might not be possible to create a good simplified version of this page.\\nYou may want to clip the complete page instead.';\n\t\t}\n\n\t\treturn (\n\t\t\t<div className=\"App\">\n\t\t\t\t<div className=\"Controls\">\n\t\t\t\t\t<ul>\n\t\t\t\t\t\t<li><a className=\"Button\" href=\"#\" onClick={this.clipSimplified_click} title={simplifiedPageButtonTooltip}>{simplifiedPageButtonLabel}</a></li>\n\t\t\t\t\t\t<li><a className=\"Button\" href=\"#\" onClick={this.clipComplete_click}>Clip complete page (Markdown)</a></li>\n\t\t\t\t\t\t<li><a className=\"Button\" href=\"#\" onClick={this.clipCompleteHtml_click}>Clip complete page (HTML)</a></li>\n\t\t\t\t\t\t<li><a className=\"Button\" href=\"#\" onClick={this.clipSelection_click}>Clip selection</a></li>\n\t\t\t\t\t\t<li><a className=\"Button\" href=\"#\" onClick={this.clipScreenshot_click}>Clip screenshot</a></li>\n\t\t\t\t\t\t<li><a className=\"Button\" href=\"#\" onClick={this.clipUrl_click}>Clip URL</a></li>\n\t\t\t\t\t</ul>\n\t\t\t\t</div>\n\t\t\t\t{ foldersComp() }\n\t\t\t\t<div className=\"Tags\">\n\t\t\t\t\t<label>Tags:</label>\n\t\t\t\t\t{tagsComp()}\n\t\t\t\t\t<datalist id=\"tags\">\n\t\t\t\t\t\t{tagDataListOptions}\n\t\t\t\t\t</datalist>\n\t\t\t\t</div>\n\t\t\t\t{ warningComponent }\n\t\t\t\t{ previewComponent }\n\t\t\t\t{ openNewNoteButton() }\n\t\t\t\t{ clipperStatusComp() }\n\t\t\t</div>\n\t\t);\n\t}\n\n}\n\nconst mapStateToProps = (state) => {\n\treturn {\n\t\twarning: state.warning,\n\t\tclippedContent: state.clippedContent,\n\t\tcontentUploadOperation: state.contentUploadOperation,\n\t\tclipperServer: state.clipperServer,\n\t\tfolders: state.folders,\n\t\ttags: state.tags,\n\t\tselectedFolderId: state.selectedFolderId,\n\t\tisProbablyReaderable: state.isProbablyReaderable,\n\t\tauthStatus: state.authStatus,\n\t};\n};\n\nconst App = connect(mapStateToProps)(AppComponent);\n\nexport default App;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport App from './App';\n\nconst { Provider } = require('react-redux');\nconst { bridge } = require('./bridge');\nconst { createStore, applyMiddleware } = require('redux');\n\nconst defaultState = {\n\twarning: '',\n\tclippedContent: null,\n\tcontentUploadOperation: null,\n\tclipperServer: {\n\t\tfoundState: 'idle',\n\t\tport: null,\n\t},\n\tfolders: [],\n\ttags: [],\n\tselectedFolderId: null,\n\tenv: 'prod',\n\tisProbablyReaderable: true,\n\tauthStatus: 'starting',\n};\n\nconst reduxMiddleware = store => next => async (action) => {\n\tconst result = next(action);\n\tconst newState = store.getState();\n\n\tif (['SELECTED_FOLDER_SET'].indexOf(action.type) >= 0) {\n\t\tbridge().scheduleStateSave(newState);\n\t}\n\n\treturn result;\n};\n\nfunction reducer(state = defaultState, action) {\n\tlet newState = state;\n\n\tif (action.type === 'WARNING_SET') {\n\n\t\tnewState = Object.assign({}, state);\n\t\tnewState.warning = action.text;\n\n\t} else if (action.type === 'IS_PROBABLY_READERABLE') {\n\n\t\tnewState = Object.assign({}, state);\n\t\tnewState.isProbablyReaderable = action.value;\n\n\t} else if (action.type === 'CLIPPED_CONTENT_SET') {\n\n\t\tnewState = Object.assign({}, state);\n\t\tnewState.clippedContent = action.content;\n\n\t} else if (action.type === 'CLIPPED_CONTENT_TITLE_SET') {\n\n\t\tnewState = Object.assign({}, state);\n\t\tconst newContent = newState.clippedContent ? Object.assign({}, newState.clippedContent) : {};\n\t\tnewContent.title = action.text;\n\t\tnewState.clippedContent = newContent;\n\n\t} else if (action.type === 'CONTENT_UPLOAD') {\n\n\t\tnewState = Object.assign({}, state);\n\t\tnewState.contentUploadOperation = action.operation;\n\n\t} else if (action.type === 'FOLDERS_SET') {\n\n\t\tnewState = Object.assign({}, state);\n\t\tnewState.folders = action.folders;\n\n\t\tif (!newState.selectedFolderId && action.folders.length) {\n\t\t\tnewState.selectedFolderId = action.folders[0].id;\n\t\t}\n\n\t} else if (action.type === 'TAGS_SET') {\n\n\t\tnewState = Object.assign({}, state);\n\t\tnewState.tags = action.tags;\n\n\t} else if (action.type === 'SELECTED_FOLDER_SET') {\n\n\t\tnewState = Object.assign({}, state);\n\t\tnewState.selectedFolderId = action.id;\n\n\t} else if (action.type === 'CLIPPER_SERVER_SET') {\n\n\t\tnewState = Object.assign({}, state);\n\t\tconst clipperServer = Object.assign({}, newState.clipperServer);\n\t\tif ('foundState' in action) clipperServer.foundState = action.foundState;\n\t\tif ('port' in action) clipperServer.port = action.port;\n\t\tnewState.clipperServer = clipperServer;\n\n\t} else if (action.type === 'ENV_SET') {\n\n\t\tnewState = Object.assign({}, state);\n\t\tnewState.env = action.env;\n\n\t} else if (action.type === 'AUTH_STATE_SET') {\n\n\t\tnewState = Object.assign({}, state);\n\t\tnewState.authStatus = action.value;\n\n\t}\n\n\treturn newState;\n}\n\nasync function main() {\n\tconst store = createStore(reducer, applyMiddleware(reduxMiddleware));\n\n\tconsole.info('Popup: Init bridge and restore state...');\n\n\tawait bridge().init(window.browser ? window.browser : window.chrome, !!window.browser, store);\n\n\tconsole.info('Popup: Creating React app...');\n\n\tReactDOM.render(<Provider store={store}><App /></Provider>, document.getElementById('root'));\n}\n\nmain().catch((error) => {\n\tconsole.error('Fatal error on initialisation:', error);\n});\n"],"sourceRoot":""}